LVS 的基本原理和配置方法
------------------------

###LVS简介

![linux-lvs-001-018][linux-lvs-001-018]

1.集群定义

1)集群是一种并行或分布式系统，该系统：

a.包括一个互连的整体计算机集合

b.作为一种单一、统一的计算资源使用

2)计算机集群简称集群，是一种计算机系统， 它通过一组松散集成的计算机软件和/或硬件连接起来高度紧密地协作完成计算工作。

3)计算机集群简称集群，是指一组相互独立的计算机，利用高速通信网络组成一个计算机系统，每个集群节点（即集群中的每台计算机）都是运行其自己进程的一个独立服务器。这些进程可以彼此通信，对网络客户机来说就像形成了一个单一系统，协同起来向用户提供应用程序、系统资源和数据，并以单一系统的模式加以管理。一个客户与集群相互作用时，集群像是一个独立的服务器。

2.集群分类

集群计算机按功能和结构可以分成以下几类:

1)高可用性集群 High-availability (HA) clusters

一般是指当集群中有某个节点失效的情况下，其上的任务会自动转移到其他正常的节点上。还指可以将集群中的某节点进行离线维护再上线，该过程并不影响整个集群的运行。

2)负载均衡集群 Load balancing clusters

负载均衡集群运行时，一般通过一个或者多个前端负载均衡器将工作负载分发到后端的一组服务器上，从而达到整个系统的高性能和高可用性。这样的计算机集群有时也被称为服务器群（Server Farm）。 一般高可用性集群和负载均衡集群会使用类似的技术，或同时具有高可用性与负载均衡的特点。

Linux虚拟服务器（LVS）项目在Linux操作系统上提供了最常用的负载均衡软件。

3)高性能计算集群 High-performance (HPC) clusters

4)网格计算 Grid computing

3.负载均衡：

负载均衡（Load Balance）建立在现有网络结构之上，它提供了一种廉价、有效、透明的方法，来扩展网络设备和服务器的带宽、增加吞吐量、加强网络数据处理能力、提高网络的灵活性和可用性。

负载均衡有两方面的含义：

首先，大量的并发访问或数据流量分担到多台节点设备上分别处理，减少用户等待响应的时间；

其次，单个重负载的运算分担到多台节点设备上做并行处理，每个节点设备处理结束后，将结果汇总，返回给用户，系统处理能力得到大幅度提高。

![linux-lvs-002-018][linux-lvs-002-018]

###负载均衡集群

1.LVS基本原理– 命名约定

为了更加易于探讨此网络通信，LVS社区已经开发了一个命名的约定，以便基于每种类型的IP地址在网络对话中的角色来描述每种类型的IP地址。

1)虚拟IP地址（VIP）：Director用于向客户端计算机提供服务的IP地址

真实IP地址（RIP）：在集群节点上使用IP地址

2)Director的IP地址(DIP)：Director用于连接到D/RIP网络的IP地址

3)客户端计算机的IP地址(CIP):分配给客户端计算机的IP地址,该地址用作发送给集群的请求的源IP地址。

4)D/RIP网络:由Director和Real Server组成的网络

![linux-lvs-003-018][linux-lvs-003-018]

2.LVS集群的类型

LVS集群通常是由LVS Director用于中继入站请求到集群内部节点的转发方法类型描述的。

目前可用的三种方法是：

1)网络地址转换（LVS-NAT）

2)直接路由(LVS-DR)

3)IP隧道（LVS-TUN）

3.LVS的调度方法

调度方法决定了如何在这些集群节点之间分布工作负荷。

当Director收到来自客户端计算机访问它的VIP上的集群服务的入站请求时，Director必须决定哪个集群节点应该获得请求。

Director可用于做出该决定的调度方法分成两个基本类别：

1)固定调度方法：循环（RR）、待权重的循环（WRR）、目的散列、源散列

2)动态调度算法：最小连接（LC）、带权重的最小连接（WLC）、最短期望延迟（SED）、无须队列等待（NQ）、基于位置的最小连接（LBLC）、带复制调度的基于位置最小连接(LBLCR)

4.LVS-DR方式：直接路由

在LVS-DR配置中，Director将所有入站请求转发给集群内部节点，但集群内部的节点直接将它们的回复发送给客户端计算机（没有通过Director回来）。如图所示：

5.LVS-DR集群 工作

来自客户端计算机或CIP的请求被发送到Director的VIP。然后Director使用相同的VIP目的IP地址将请求发送到集群节点或真实服务器。然后，集群节点将回复数据包直接发送到客户端计算机，并且此回复数据包使用VIP作为源IP地址。因此，客户计算机被欺骗，认为它正在与一台计算机对话，而实际上这时它正在发送请求数据包给一台计算机，并从另一台计算机接受回复数据包。

6.LVS/DR的基本原理

1)LVS调度器收到目标地址为VIP的请求包后，将MAC地址改成RS的MAC地址，并通过交换机(链路层)发给RS

2)RS的链路层收到请求后，往上传给IP层。IP层需要验证请求的目标IP地址。所以RS需要配置一个VIP的loopback device。这样RS的IP层收到报文后，会往上递交给传输层。之所以配置成loopback device，是因为loopback device对外不可见，不会跟LVS的VIP冲突。

3)RS处理完成后，将应答包直接返回给客户端。若是公网服务器，则RS需要连上互联网（公网IP或者网关）才能将应答包返回。

![linux-lvs-004-018][linux-lvs-004-018]

LVS/DR的基本属性

a.集群节点必须和Director在相同的物理网段上

b.Director截获客户端和真实服务器之间的入站（而不是出站）通信

c.集群节点（通常）没有使用Director作为默认网关，以便将数据包直接回复给客户端计算机。

d.大多数操作系统可以用在集群内部的真实服务器上，只要该操作系统能够实现ARP隐藏

e.LVS/DR Director （100）可以比LVS-NAT Director（10-20）处理更多的真实服务器

7.ARP广播和隐藏问题

![linux-lvs-005-018][linux-lvs-005-018]

![linux-lvs-006-018][linux-lvs-006-018]

###LVS 配置方法 

(配置LVS前确保安装了ipvsadm管理软件)

配置步骤

组网

>配置Director
>
>配置RealServer
>
>测试与验证

1.LVS/DR 配置方法

1)组建如图网络环境 

![linux-lvs-007-018][linux-lvs-007-018]

2)在LVS服务器上运行一下脚本

3)测试验证

![linux-lvs-008-018][linux-lvs-008-018]

2.LVS/NAT 配置方法

1)组建如图网络环境

![linux-lvs-009-018][linux-lvs-009-018]

2)配置虚拟IP

a.在LVS上运行

b.在WEB服务器上运行

3)在LVS服务器上运行一下脚本

4)测试验证

![linux-lvs-010-018][linux-lvs-010-018]

[linux-lvs-001-018]: /linux/linux-lvs-001-018.png
[linux-lvs-002-018]: /linux/linux-lvs-002-018.jpg
[linux-lvs-003-018]: /linux/linux-lvs-003-018.png
[linux-lvs-004-018]: /linux/linux-lvs-004-018.png
[linux-lvs-005-018]: /linux/linux-lvs-005-018.png
[linux-lvs-006-018]: /linux/linux-lvs-006-018.png
[linux-lvs-007-018]: /linux/linux-lvs-007-018.png
[linux-lvs-008-018]: /linux/linux-lvs-008-018.png
[linux-lvs-009-018]: /linux/linux-lvs-009-018.png
[linux-lvs-010-018]: /linux/linux-lvs-010-018.png
